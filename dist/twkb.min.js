!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).twkb=e()}(this,(function(){"use strict";const t=1,e=2,r=3,n=4,o=5,s=6,u=7,f=11,c=Number.MAX_VALUE;function i(t){let e,r=t.cursor,n=0,o=0;for(;;){if(0==(128&(e=t.buffer[r])))return r++,t.cursor=r,n|e<<o;n|=(127&e)<<o,r++,o+=7}}function a(t){return b(i(t))}function b(t){return 0==(1&t)?t>>1:-(t>>1)-1}function p(t){throw new Error("Unknown type: "+t)}function d(g,_){let w,v=0,L=0;w=g.buffer[g.cursor],g.cursor++;const z=b((240&w)>>4);if(g.type=15&w,g.factors=[],g.factors[0]=g.factors[1]=Math.pow(10,z),w=g.buffer[g.cursor],g.cursor++,g.has_bbox=1&w,g.has_size=(2&w)>>1,g.has_idlist=(4&w)>>2,g.is_empty=(16&w)>>4,(8&w)>>3){const t=g.buffer[g.cursor];g.cursor++,L=(2&t)>>1;const e=(28&t)>>2,r=(224&t)>>5;(v=1&t)&&(g.factors[2]=Math.pow(10,e)),L&&(g.factors[2+v]=Math.pow(10,r)),g.has_z=v,g.has_m=L}const A=2+v+L;if(g.ndims=A,g.has_size&&(g.size=i(g)),g.has_bbox){const t=[];for(let e=0;e<=A-1;e++){const r=a(g),n=r+a(g);t[e]=r,t[e+A]=n}g.bbox=t}return function(a,b){const g=a.type;for(let t=0;t<a.ndims;t++)a.refpoint[t]=0;switch(g){case t:return h(a);case e:return y(a);case r:return l(a);case n:case f:return m(a,h);case o:return m(a,y);case s:return m(a,l);case u:return function(t,e){const r=t.ndims,n=i(t),o=[],s=x(t,n);for(let r=0;r<n&&r<e;r++){const e=d(t),r=t.type;o.push({type:r,coordinates:e})}return{type:u,ids:s,ndims:r,offset:e<c?t.cursor:void 0,geoms:o}}(a);default:p(g)}}(g)}function h(t){return g(t,1)}function y(t){return g(t,i(t))}function l(t){const e=[],r=i(t);for(let n=0;n<r;++n)e[n]=y(t);return e}function m(t,e){const r=t.type,n=i(t),o=[],s=x(t,n);for(let r=0;r<n;r++)o.push(e(t));return{type:r,ids:s,geoms:o}}function g(t,e){let r,n;const o=t.ndims,s=t.factors,u=new Array(e*o);for(r=0;r<e;r++)for(n=0;n<o;n++)t.refpoint[n]+=a(t),u[o*r+n]=t.refpoint[n]/s[n];if(t.include_bbox&&!t.has_bbox)for(r=0;r<e;r++)for(n=0;n<o;n++){const e=u[n*o+r];e<t.bbox.min[n]&&(t.bbox.min[n]=e),e>t.bbox.max[n]&&(t.bbox.max[n]=e)}return u}function x(t,e){const r=[];if(t.has_idlist)for(let n=0;n<e;n++)r.push(a(t));return r}function _(n){switch(n){case t:return"Point";case e:return"Linestring";case r:return"Polygon";case f:return"Triangle";default:p(n)}}function w(t,e){return{type:_(t),coordinates:e}}function v(t,e,r,n){return{type:"Feature",id:r,geometry:A(t)(t,e,n)}}function L(t,e,r,n){return e.map((e,o)=>v(t,e,r?r[o]:void 0,n))}function z(t,e,r,n){return e.map((t,e)=>v(t.type,t.coordinates,r?r[e]:void 0,n))}function A(c){return c===t?(e,r,n)=>w(t,M(r,n)[0]):c===e?(t,r,n)=>w(e,M(r,n)):c===r?(t,e,n)=>w(r,e.map(t=>M(t,n))):c===n||c===f?(e,r,n,o)=>L(t,r,n,o):c===o?(t,r,n,o)=>L(e,r,n,o):c===s?(t,e,n,o)=>L(r,e,n,o):c===u?z:void p(c)}function M(t,e){const r=[];for(let n=0,o=t.length;n<o;n+=e){const o=[];for(let r=0;r<e;++r)o.push(t[n+r]);r.push(o)}return r}return{toGeoJSON:function(t){const e={buffer:t,cursor:0,bufferLength:t.byteLength||t.length,refpoint:[]};let r=[];for(;e.cursor<e.bufferLength;){const t=d(e);t.geoms?r=r.concat(A(t.type)(t.type,t.geoms,t.ids,e.ndims)):r.push({type:"Feature",geometry:A(e.type)(e.type,t,e.ndims)})}return{type:"FeatureCollection",features:r}},read:function(t,e,r){r=r||c;const n={buffer:t,cursor:void 0===e?0:e,bufferLength:t.byteLength||t.length,refpoint:new Int32Array(4)},o=[];let s=0;for(;n.cursor<n.bufferLength&&s<r;){const t=d(n);t.length>0?o.push({type:n.type,offset:r<c?n.cursor:void 0,bbox:n.has_bbox?n.bbox:void 0,coordinates:t}):(t.bbox=n.has_bbox?n.bbox:void 0,o.push(t)),s++}return o}}}));
